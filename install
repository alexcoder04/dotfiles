#!/bin/sh

# ------------------------------------------------------------------
# SETTINGS
# ------------------------------------------------------------------
CONFIG_REPO="${DOTFILES_REPO:-$HOME/Dotfiles}"
if [ ! -d "$CONFIG_REPO" ]; then
  echo "$CONFIG_REPO does not exist"
  exit 1
fi

# ------------------------------------------------------------------
# FUNCTIONS
# ------------------------------------------------------------------
install_subfolder(){
  [ -z "$1" ] && return

  if [ -z "$2" ]; then
    if [ -f "$XDG_DATA_HOME/conf-pc-name" ]; then
      machine="$(cat $XDG_DATA_HOME/conf-pc-name)"
      echo "using $XDG_DATA_HOME/conf-pc-name for machine name"
    else
      machine="$(cat /etc/hostname)"
      echo "using /etc/hostname for machine name"
    fi
  else
    machine="$2"
    echo "using provided argument for machine name"
  fi

  if [ ! -d "$1" ]; then
    echo "$1 is not a directory"
    return
  fi

  if [ ! -x "$1/install" ]; then
    echo "install script does not exist or is not executable, aborting."
    return
  fi

  echo "Sourcing settings..."
  . "./$machine.prefs2"
  . "./themes/$RECONF_THEME/$RECONF_THEME.prefs2"

  cd "$1"
  echo "Installing \033[34m$1\033[0m for \033[33m$machine\033[0m..."
  ./install "$machine"
  cd "$OLDPWD"
}

# ------------------------------------------------------------------
# ACTUAL SCRIPT
# ------------------------------------------------------------------
cd "$CONFIG_REPO"
if [ -z "$1" ]; then
  echo "\033[31mYou need to provide a package to install\033[0m"
  exit 1
fi

install_subfolder "$1"

