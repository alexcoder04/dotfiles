#!/usr/bin/env python3

import os
import sys

def read_settings_file(filename, settings=None):
    if settings is None:
        settings = {}
    f = open(filename)
    for line in f.readlines():
        line = line.strip()
        if line == "" or line.startswith("#"):
            continue
        if line.startswith("%include"):
            settings = read_settings_file(
                f"{os.path.dirname(filename)}/{' '.join(line.split()[1:])}",
                settings=settings
            )
            continue
        settings[line.split()[0]] = " ".join(line.split()[1:])
    f.close()
    return settings

override = {}
setting_files = []
for arg in sys.argv[1:]:
    if arg.startswith("#"):
        [key, value] = arg[1:].split("=")
        override[key] = value
        continue
    setting_files.append(arg)

if len(setting_files) == 0:
    print("No setting files provided")
    sys.exit(1)

data = sys.stdin.read()

settings = read_settings_file(setting_files[0])
for file in setting_files[1:]:
    settings = read_settings_file(file, settings=settings)

settings.update(override)

for key in settings:
    data = data.replace(f"+{key}+", settings[key])

sys.stdout.write(data)

